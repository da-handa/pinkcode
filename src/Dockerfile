# --- 1ë‹¨ê³„: ë¹Œë“œ í™˜ê²½ (Builder) ---
FROM rust:latest AS builder

# ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ì˜ì¡´ì„± ë¯¸ë¦¬ ìºì‹œ ë° ë¹Œë“œ
COPY Cargo.toml Cargo.lock ./
# ì„ì‹œ main.rs íŒŒì¼ë¡œ ì˜ì¡´ì„±ë§Œ ë¹Œë“œí•˜ì—¬ ìºì‹œí•©ë‹ˆë‹¤.
RUN mkdir src/ && echo "fn main() {}" > src/main.rs && cargo build --release
RUN rm -rf target/release/deps/pinkcodeserver target/release/pinkcodeserver

# ì „ì²´ ì†ŒìŠ¤ ì½”ë“œ ë³µì‚¬ ë° ìµœì¢… ë¹Œë“œ
COPY . .
# ì‹¤í–‰ íŒŒì¼ ì´ë¦„ì´ 'pinkcodeserver'ì´ë¼ê³  ê°€ì •í•©ë‹ˆë‹¤.
RUN cargo build --release

# --- 2ë‹¨ê³„: ì‹¤í–‰ í™˜ê²½ (Runner) ---
FROM debian:stable-slim

# ğŸ› ï¸ ìˆ˜ì •: libssl3 ì„¤ì¹˜ ë° APT ìºì‹œ ì œê±° (ì¤‘ìš”!)
RUN apt-get update && apt-get install -y \
    libssl3 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*
    
# ... (ë‚˜ë¨¸ì§€ ì½”ë“œ ìœ ì§€) ...

# Builder ë‹¨ê³„ì—ì„œ ë¹Œë“œëœ ì‹¤í–‰ íŒŒì¼ë§Œ ë³µì‚¬í•©ë‹ˆë‹¤.
COPY --from=builder /app/target/release/pink-code-server /usr/local/bin/

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (Fly.ioì—ì„œ ê¸°ë³¸ì ìœ¼ë¡œ 8080 í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ì„¤ì •í–ˆëŠ”ì§€ í™•ì¸)
ENV PORT=8080

# ì„œë²„ ì‹¤í–‰ ëª…ë ¹ì–´
CMD ["/usr/local/bin/pink-code-server"]